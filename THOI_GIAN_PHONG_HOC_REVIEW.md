# üîç KI·ªÇM TRA CODE QU·∫¢N L√ù TH·ªúI GIAN & PH√íNG H·ªåC

**Ng√†y ki·ªÉm tra:** October 11, 2025  
**Ph·∫°m vi:** KhoaHocController, HocKyController, PhongHocController

---

## üìä T·ªîNG QUAN

| Controller             | Tr·∫°ng th√°i | V·∫•n ƒë·ªÅ Critical | V·∫•n ƒë·ªÅ Medium | V·∫•n ƒë·ªÅ Logic | T·ªïng  |
| ---------------------- | ---------- | --------------- | ------------- | ------------ | ----- |
| **KhoaHocController**  | ‚ö†Ô∏è         | 1               | 1             | 0            | **2** |
| **HocKyController**    | üö®         | 3               | 0             | 1            | **4** |
| **PhongHocController** | ‚úÖ         | 0               | 0             | 0            | **0** |

---

## üö® 1. KHOA_HOC - 2 V·∫§N ƒê·ªÄ

### **A. Model thi·∫øu field `mo_ta`** (Critical)

**File:** `app/Models/HeThong/KhoaHoc.php` - Line 14

**V·∫•n ƒë·ªÅ:**

```php
// ‚ùå Model thi·∫øu field mo_ta
protected $fillable = [
    'ten_khoa_hoc',
    'nam_bat_dau',
    'nam_ket_thuc',
    // THI·∫æU: 'mo_ta'
];
```

**Trong khi Controller validate:**

```php
// ‚úÖ Controller c√≥ validate mo_ta
$validated = $request->validate([
    'ten_khoa_hoc' => '...',
    'nam_bat_dau' => '...',
    'nam_ket_thuc' => '...',
    'mo_ta' => 'nullable|string|max:500',  // ‚Üê C√≥ validate
]);
```

**‚ö†Ô∏è H·∫¨U QU·∫¢:**

-   ‚ùå Field `mo_ta` **KH√îNG L∆ØU** v√†o database
-   ‚ùå Form c√≥ input nh∆∞ng data b·ªã m·∫•t

**‚úÖ FIX:**

```php
protected $fillable = [
    'ten_khoa_hoc',
    'nam_bat_dau',
    'nam_ket_thuc',
    'mo_ta',  // TH√äM
];
```

---

### **B. ERD thi·∫øu field `mo_ta`** (Medium)

**File:** `database.dbml` - Line 279

**ERD hi·ªán t·∫°i:**

```dbml
Table khoa_hoc {
  id int [pk]
  ten_khoa_hoc varchar [not null]
  nam_bat_dau int
  nam_ket_thuc int
  // THI·∫æU: mo_ta text
}
```

**‚úÖ N√äN TH√äM:**

```dbml
Table khoa_hoc {
  id int [pk]
  ten_khoa_hoc varchar [not null]
  nam_bat_dau int
  nam_ket_thuc int
  mo_ta text [note: 'M√¥ t·∫£ kh√≥a h·ªçc']
}
```

---

## üö® 2. HOC_KY - 4 V·∫§N ƒê·ªÄ NGHI√äM TR·ªåNG

### **A. Controller validate sai t√™n tr∆∞·ªùng** (Critical)

**File:** `HocKyController.php` - Line 38

**V·∫•n ƒë·ªÅ:**

```php
// ‚ùå Controller validate 'hoc_ky' (INTEGER)
$validated = $request->validate([
    'khoa_hoc_id' => 'required|exists:khoa_hoc,id',
    'hoc_ky' => [  // ‚Üê SAI T√äN FIELD
        'required',
        'integer',
        'min:1',
        'max:10',
        Rule::unique('hoc_ky')->where(...)
    ],
]);
```

**Nh∆∞ng ERD ƒë·ªãnh nghƒ©a:**

```dbml
Table hoc_ky {
  id int [pk]
  ten_hoc_ky varchar [not null]  // ‚Üê T√äN ƒê√öNG
  nam_bat_dau int
  nam_ket_thuc int
  ngay_bat_dau date
  ngay_ket_thuc date
}
```

**Model c≈©ng d√πng t√™n kh√°c:**

```php
protected $fillable = [
    'ten_hoc_ky',  // ‚Üê T√äN ƒê√öNG
    'nam_bat_dau',
    'nam_ket_thuc',
    'ngay_bat_dau',
    'ngay_ket_thuc',
];
```

**‚ö†Ô∏è H·∫¨U QU·∫¢:**

-   üö® **DATA KH√îNG BAO GI·ªú L∆ØU** v√†o field `ten_hoc_ky`
-   üö® Form submit nh∆∞ng **field b·ªã NULL**
-   üö® Unique validation **KH√îNG HO·∫†T ƒê·ªòNG**

**‚úÖ FIX:**

```php
// S·ª≠a t·∫•t c·∫£ 'hoc_ky' ‚Üí 'ten_hoc_ky'
$validated = $request->validate([
    'khoa_hoc_id' => 'required|exists:khoa_hoc,id',
    'ten_hoc_ky' => [  // ‚Üê S·ª¨A
        'required',
        'string',  // ‚Üê ƒê·ªîI TH√ÄNH STRING
        'max:100',
        Rule::unique('hoc_ky')->where(function ($query) use ($request) {
            return $query->where('khoa_hoc_id', $request->khoa_hoc_id);
        })
    ],
    'ngay_bat_dau' => 'required|date',
    'ngay_ket_thuc' => 'required|date|after:ngay_bat_dau',
    'mo_ta' => 'nullable|string|max:500',
]);
```

---

### **B. Model thi·∫øu field `khoa_hoc_id`** (Critical)

**File:** `app/Models/HeThong/HocKy.php` - Line 14

**V·∫•n ƒë·ªÅ:**

```php
// ‚ùå Thi·∫øu khoa_hoc_id
protected $fillable = [
    'ten_hoc_ky',
    'nam_bat_dau',
    'nam_ket_thuc',
    'ngay_bat_dau',
    'ngay_ket_thuc',
    // THI·∫æU: 'khoa_hoc_id'
];
```

**Controller validate c√≥:**

```php
'khoa_hoc_id' => 'required|exists:khoa_hoc,id',
```

**‚ö†Ô∏è H·∫¨U QU·∫¨:**

-   üö® **Kh√¥ng th·ªÉ g√°n h·ªçc k·ª≥ cho kh√≥a h·ªçc**
-   üö® Foreign key **KH√îNG L∆ØU**

**‚úÖ FIX:**

```php
protected $fillable = [
    'khoa_hoc_id',  // TH√äM
    'ten_hoc_ky',
    'nam_bat_dau',
    'nam_ket_thuc',
    'ngay_bat_dau',
    'ngay_ket_thuc',
    'mo_ta',  // N√äN TH√äM
];
```

---

### **C. Model thi·∫øu field `mo_ta`** (Critical)

**T∆∞∆°ng t·ª± KhoaHoc, HocKy c≈©ng thi·∫øu `mo_ta` trong Model**

---

### **D. Model thi·∫øu relationship `khoaHoc`** (Medium)

**File:** `app/Models/HeThong/HocKy.php`

**V·∫•n ƒë·ªÅ:**

```php
// ‚ùå THI·∫æU relationship v·ªõi KhoaHoc
public function lopHocPhans() { ... }
public function bangDiems() { ... }
public function hocPhis() { ... }
// THI·∫æU: public function khoaHoc()
```

**Controller c√≥ d√πng:**

```php
$hocKys = HocKy::with('khoaHoc')  // ‚Üê D√πng relationship
    ->orderBy('khoa_hoc_id', 'desc')
    ->paginate(15);
```

**‚ö†Ô∏è H·∫¨U QU·∫¨:**

-   üö® **Query error** khi load relationship
-   üö® View kh√¥ng hi·ªÉn th·ªã ƒë∆∞·ª£c t√™n kh√≥a h·ªçc

**‚úÖ FIX:**

```php
public function khoaHoc()
{
    return $this->belongsTo(KhoaHoc::class, 'khoa_hoc_id');
}
```

---

### **E. Controller `destroy()` thi·∫øu validation** (Logic issue)

**File:** `HocKyController.php` - Line 121

**V·∫•n ƒë·ªÅ:**

```php
// ‚ùå X√ìA TR·ª∞C TI·∫æP KH√îNG KI·ªÇM TRA
public function destroy(string $id)
{
    $hocKy = HocKy::findOrFail($id);
    $hocKy->delete();  // Nguy hi·ªÉm!

    return redirect()->route('admin.hoc-ky.index')
        ->with('success', 'X√≥a h·ªçc k·ª≥ th√†nh c√¥ng');
}
```

**‚ö†Ô∏è H·∫¨U QU·∫¨:**

-   ‚ùå X√≥a h·ªçc k·ª≥ ƒëang c√≥ l·ªõp h·ªçc ph·∫ßn
-   ‚ùå X√≥a h·ªçc k·ª≥ ƒëang c√≥ b·∫£ng ƒëi·ªÉm
-   ‚ùå X√≥a h·ªçc k·ª≥ ƒëang c√≥ h·ªçc ph√≠
-   üö® **Data orphan ho·∫∑c foreign key error**

**‚úÖ FIX:**

```php
public function destroy(string $id)
{
    $hocKy = HocKy::findOrFail($id);

    // Ki·ªÉm tra c√≥ l·ªõp h·ªçc ph·∫ßn
    if ($hocKy->lopHocPhans()->count() > 0) {
        return redirect()->route('admin.hoc-ky.index')
            ->with('error', 'Kh√¥ng th·ªÉ x√≥a h·ªçc k·ª≥ n√†y v√¨ ƒëang c√≥ l·ªõp h·ªçc ph·∫ßn!');
    }

    // Ki·ªÉm tra c√≥ b·∫£ng ƒëi·ªÉm
    if ($hocKy->bangDiems()->count() > 0) {
        return redirect()->route('admin.hoc-ky.index')
            ->with('error', 'Kh√¥ng th·ªÉ x√≥a h·ªçc k·ª≥ n√†y v√¨ ƒëang c√≥ b·∫£ng ƒëi·ªÉm!');
    }

    // Ki·ªÉm tra c√≥ h·ªçc ph√≠
    if ($hocKy->hocPhis()->count() > 0) {
        return redirect()->route('admin.hoc-ky.index')
            ->with('error', 'Kh√¥ng th·ªÉ x√≥a h·ªçc k·ª≥ n√†y v√¨ ƒëang c√≥ h·ªçc ph√≠!');
    }

    $hocKy->delete();

    return redirect()->route('admin.hoc-ky.index')
        ->with('success', 'X√≥a h·ªçc k·ª≥ th√†nh c√¥ng');
}
```

---

## ‚úÖ 3. PHONG_HOC - HO√ÄN H·∫¢O!

**File:** `PhongHocController.php`

**ƒê√°nh gi√°:**

-   ‚úÖ Model c√≥ ƒë·ªß 7 fields
-   ‚úÖ Migration ƒë√£ ch·∫°y xong
-   ‚úÖ Validation ƒë·∫ßy ƒë·ªß
-   ‚úÖ Delete c√≥ check relationship
-   ‚úÖ ERD ƒë√£ c·∫≠p nh·∫≠t

**Kh√¥ng c√≥ v·∫•n ƒë·ªÅ g√¨!** üéâ

---

## üìã B·∫¢NG T·ªîNG H·ª¢P V·∫§N ƒê·ªÄ

| Module       | V·∫•n ƒë·ªÅ                    | M·ª©c ƒë·ªô      | File                | Fix Priority |
| ------------ | ------------------------- | ----------- | ------------------- | ------------ |
| **KhoaHoc**  | Model thi·∫øu `mo_ta`       | üö® Critical | KhoaHoc.php         | **HIGH**     |
| **KhoaHoc**  | ERD thi·∫øu `mo_ta`         | ‚ö†Ô∏è Medium   | database.dbml       | **MEDIUM**   |
| **HocKy**    | Controller sai t√™n field  | üö® Critical | HocKyController.php | **CRITICAL** |
| **HocKy**    | Model thi·∫øu `khoa_hoc_id` | üö® Critical | HocKy.php           | **CRITICAL** |
| **HocKy**    | Model thi·∫øu `mo_ta`       | üö® Critical | HocKy.php           | **HIGH**     |
| **HocKy**    | Model thi·∫øu relationship  | ‚ö†Ô∏è Medium   | HocKy.php           | **HIGH**     |
| **HocKy**    | Delete kh√¥ng check        | ‚ö†Ô∏è Logic    | HocKyController.php | **HIGH**     |
| **PhongHoc** | Kh√¥ng c√≥ v·∫•n ƒë·ªÅ           | ‚úÖ OK       | -                   | -            |

---

## ‚úÖ DANH S√ÅCH C√îNG VI·ªÜC C·∫¶N L√ÄM

### **Priority 1 (CRITICAL - L√†m ngay!):**

#### **1. Fix HocKyController - ƒê·ªïi t√™n field**

```php
// File: HocKyController.php
// ƒê·ªïi T·∫§T C·∫¢ 'hoc_ky' ‚Üí 'ten_hoc_ky'
// ƒê·ªïi validation t·ª´ integer ‚Üí string
```

#### **2. Fix HocKy Model - Th√™m 3 fields**

```php
// File: HocKy.php
protected $fillable = [
    'khoa_hoc_id',  // TH√äM
    'ten_hoc_ky',
    'nam_bat_dau',
    'nam_ket_thuc',
    'ngay_bat_dau',
    'ngay_ket_thuc',
    'mo_ta',  // TH√äM
];
```

#### **3. Fix HocKy Model - Th√™m relationship**

```php
// File: HocKy.php
public function khoaHoc()
{
    return $this->belongsTo(KhoaHoc::class, 'khoa_hoc_id');
}
```

---

### **Priority 2 (HIGH - L√†m h√¥m nay):**

#### **4. Fix KhoaHoc Model - Th√™m field**

```php
// File: KhoaHoc.php
protected $fillable = [
    'ten_khoa_hoc',
    'nam_bat_dau',
    'nam_ket_thuc',
    'mo_ta',  // TH√äM
];
```

#### **5. Fix HocKyController destroy()**

-   Th√™m check `lopHocPhans()->count()`
-   Th√™m check `bangDiems()->count()`
-   Th√™m check `hocPhis()->count()`

---

### **Priority 3 (MEDIUM - L√†m trong tu·∫ßn):**

#### **6. C·∫≠p nh·∫≠t ERD**

```dbml
// Th√™m mo_ta v√†o khoa_hoc
// C·∫≠p nh·∫≠t hoc_ky structure
```

---

## üéØ ∆Ø·ªöC T√çNH TH·ªúI GIAN

| Task                                      | Time       | Difficulty |
| ----------------------------------------- | ---------- | ---------- |
| Fix HocKyController field name            | 10 ph√∫t    | Easy       |
| Fix HocKy Model (3 fields + relationship) | 5 ph√∫t     | Easy       |
| Fix KhoaHoc Model (1 field)               | 2 ph√∫t     | Easy       |
| Fix HocKy destroy()                       | 15 ph√∫t    | Medium     |
| C·∫≠p nh·∫≠t ERD                              | 5 ph√∫t     | Easy       |
| Test l·∫°i                                  | 20 ph√∫t    | Easy       |
| **T·ªîNG**                                  | **~1 gi·ªù** | -          |

---

## üî• V·∫§N ƒê·ªÄ NGHI√äM TR·ªåNG NH·∫§T

### **HocKyController validate SAI T√äN FIELD:**

**Hi·ªán t·∫°i:**

```php
'hoc_ky' => [  // ‚Üê SAI!
    'required',
    'integer',  // ‚Üê SAI KI·ªÇU!
```

**Ph·∫£i l√†:**

```php
'ten_hoc_ky' => [  // ‚Üê ƒê√öNG
    'required',
    'string',  // ‚Üê ƒê√öNG KI·ªÇU
    'max:100',
```

**‚Üí ƒê√¢y l√† l·ªói CRITICAL khi·∫øn data KH√îNG L∆ØU ƒë∆∞·ª£c!**

---

## üìä SO S√ÅNH CONTROLLER vs MODEL vs ERD

### **KHOA_HOC:**

| Field        | Controller | Model | ERD | Status    |
| ------------ | ---------- | ----- | --- | --------- |
| ten_khoa_hoc | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK        |
| nam_bat_dau  | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK        |
| nam_ket_thuc | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK        |
| mo_ta        | ‚úÖ         | ‚ùå    | ‚ùå  | **THI·∫æU** |

### **HOC_KY:**

| Field               | Controller | Model | ERD | Status      |
| ------------------- | ---------- | ----- | --- | ----------- |
| khoa_hoc_id         | ‚úÖ         | ‚ùå    | ‚úÖ  | **THI·∫æU**   |
| ten_hoc_ky / hoc_ky | ‚ùå         | ‚úÖ    | ‚úÖ  | **SAI T√äN** |
| nam_bat_dau         | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK          |
| nam_ket_thuc        | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK          |
| ngay_bat_dau        | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK          |
| ngay_ket_thuc       | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK          |
| mo_ta               | ‚úÖ         | ‚ùå    | ‚ùå  | **THI·∫æU**   |

### **PHONG_HOC:**

| Field      | Controller | Model | ERD | Status |
| ---------- | ---------- | ----- | --- | ------ |
| ma_phong   | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK     |
| ten_phong  | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK     |
| suc_chua   | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK     |
| vi_tri     | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK     |
| loai_phong | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK     |
| trang_thai | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK     |
| mo_ta      | ‚úÖ         | ‚úÖ    | ‚úÖ  | OK     |

---

## üéØ K·∫æT LU·∫¨N

### **KHOA_HOC:** ‚ö†Ô∏è **Thi·∫øu nh·∫π**

-   Ch·ªâ thi·∫øu 1 field `mo_ta` trong Model v√† ERD
-   √çt ·∫£nh h∆∞·ªüng, ch·ªâ m·∫•t m√¥ t·∫£

### **HOC_KY:** üö® **V·∫§N ƒê·ªÄ NGHI√äM TR·ªåNG**

-   Controller validate **SAI T√äN FIELD** ‚Üí Data kh√¥ng l∆∞u
-   Model thi·∫øu **2 fields quan tr·ªçng** (`khoa_hoc_id`, `mo_ta`)
-   Model thi·∫øu **relationship** ‚Üí Query error
-   Delete kh√¥ng check ‚Üí Risk data integrity

### **PHONG_HOC:** ‚úÖ **HO√ÄN H·∫¢O**

-   ƒê√£ fix xong t·∫•t c·∫£ t·ª´ l·∫ßn tr∆∞·ªõc

---

**¬© 2025 S-MIS Code Review**
